{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Edit Image</h2>
    <div class="row">
        <div class="col-md-8">
            <div class="image-editor-container">
                <canvas id="imageCanvas" class="img-fluid border"></canvas>
            </div>
            
            <div class="toolbar mt-3">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="editorTabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="filters-tab" data-toggle="tab" href="#filters" role="tab">Filters</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="resize-tab" data-toggle="tab" href="#resize" role="tab">Resize</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="text-tab" data-toggle="tab" href="#text" role="tab">Text</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="emoji-tab" data-toggle="tab" href="#emoji" role="tab">Emojis</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="drawing-tab" data-toggle="tab" href="#drawing" role="tab">Draw</a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="card-body">
                        <div class="tab-content" id="editorTabContent">
                            <!-- Filters Tab -->
                            <div class="tab-pane fade show active" id="filters" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <button class="btn btn-outline-primary btn-block" data-filter="grayscale">Grayscale</button>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <button class="btn btn-outline-primary btn-block" data-filter="sepia">Sepia</button>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <button class="btn btn-outline-primary btn-block" data-filter="invert">Invert</button>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <label for="brightness">Brightness</label>
                                        <input type="range" class="custom-range" id="brightness" min="0" max="200" value="100">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="contrast">Contrast</label>
                                        <input type="range" class="custom-range" id="contrast" min="0" max="200" value="100">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resize Tab -->
                            <div class="tab-pane fade" id="resize" role="tabpanel">
                                <div class="form-row">
                                    <div class="col-md-6">
                                        <label for="width">Width (px)</label>
                                        <input type="number" class="form-control" id="width">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="height">Height (px)</label>
                                        <input type="number" class="form-control" id="height">
                                    </div>
                                    <div class="col-md-12 mt-2">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="maintainAspectRatio" checked>
                                            <label class="custom-control-label" for="maintainAspectRatio">Maintain aspect ratio</label>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mt-2">
                                        <button id="applyResize" class="btn btn-primary">Apply Resize</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Text Tab -->
                            <div class="tab-pane fade" id="text" role="tabpanel">
                                <div class="form-group">
                                    <label for="textInput">Add Text</label>
                                    <input type="text" class="form-control" id="textInput" placeholder="Enter text">
                                </div>
                                <div class="form-row">
                                    <div class="col-md-6">
                                        <label for="fontSize">Font Size</label>
                                        <input type="range" class="custom-range" id="fontSize" min="10" max="100" value="30">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="textColor">Color</label>
                                        <input type="color" class="form-control" id="textColor" value="#000000">
                                    </div>
                                </div>
                                <div class="form-group mt-2">
                                    <label for="fontFamily">Font</label>
                                    <select class="form-control" id="fontFamily">
                                        <option value="Arial">Arial</option>
                                        <option value="Verdana">Verdana</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Impact">Impact</option>
                                    </select>
                                </div>
                                <button id="addText" class="btn btn-primary mt-2">Add Text</button>
                            </div>
                            
                            <!-- Emoji Tab -->
                            <div class="tab-pane fade" id="emoji" role="tabpanel">
                                <div class="emoji-grid">
                                    <div class="row">
                                        <div class="col-2 text-center emoji-item" data-emoji="üòÄ">üòÄ</div>
                                        <div class="col-2 text-center emoji-item" data-emoji="üòÇ">üòÇ</div>
                                        <div class="col-2 text-center emoji-item" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
                                        <div class="col-2 text-center emoji-item" data-emoji="üëç">üëç</div>
                                        <div class="col-2 text-center emoji-item" data-emoji="üî•">üî•</div>
                                        <div class="col-2 text-center emoji-item" data-emoji="‚≠ê">‚≠ê</div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-2 text-center emoji-item" data-emoji="üéâ">üéâ</div>
                                        <div class="col-2 text-center emoji-item" data-emoji="üåà">üåà</div>
                                        <div class="col-2 text-center emoji-item" data-emoji="üíØ">üíØ</div>
                                        <div class="col-2 text-center emoji-item" data-emoji="üöÄ">üöÄ</div>
                                        <div class="col-2 text-center emoji-item" data-emoji="üëè">üëè</div>
                                        <div class="col-2 text-center emoji-item" data-emoji="üëë">üëë</div>
                                    </div>
                                </div>
                                <div class="form-group mt-3">
                                    <label for="emojiSize">Emoji Size</label>
                                    <input type="range" class="custom-range" id="emojiSize" min="20" max="150" value="50">
                                </div>
                            </div>
                            
                            <!-- Drawing Tab -->
                            <div class="tab-pane fade" id="drawing" role="tabpanel">
                                <div class="form-row">
                                    <div class="col-md-6">
                                        <label for="brushSize">Brush Size</label>
                                        <input type="range" class="custom-range" id="brushSize" min="1" max="30" value="5">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="brushColor">Brush Color</label>
                                        <input type="color" class="form-control" id="brushColor" value="#ff0000">
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button id="enableDrawing" class="btn btn-primary">Start Drawing</button>
                                    <button id="disableDrawing" class="btn btn-secondary ml-2">Stop Drawing</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    Actions
                </div>
                <div class="card-body">
                    <button id="resetImage" class="btn btn-warning btn-block mb-2">Reset Changes</button>
                    <button id="saveImage" class="btn btn-success btn-block">Save Image</button>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    Preview
                </div>
                <div class="card-body text-center">
                    <img id="previewImage" class="img-fluid" alt="Preview">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for submitting the edited image -->
<form id="editedImageForm" method="post" action="{% url 'save_edited_image' post.id %}" style="display:none;">
    {% csrf_token %}
    <input type="hidden" id="editedImageData" name="edited_image_data">
</form>

<!-- CSS for the editor -->
<style>
    .image-editor-container {
        max-width: 100%;
        position: relative;
    }
    
    #imageCanvas {
        background-color: #f5f5f5;
        max-width: 100%;
    }
    
    .emoji-item {
        font-size: 24px;
        cursor: pointer;
        padding: 10px;
    }
    
    .emoji-item:hover {
        background-color: #f0f0f0;
        border-radius: 5px;
    }
    
    .draggable {
        position: absolute;
        cursor: move;
    }
</style>

<!-- JavaScript for the image editor -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get canvas and context
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        
        // Original image dimensions and data
        let originalImage = new Image();
        let originalWidth, originalHeight;
        
        // Current state of the canvas
        let currentState = {
            brightness: 100,
            contrast: 100,
            grayscale: false,
            sepia: false,
            invert: false
        };
        
        // Text and emoji elements
        let textElements = [];
        let emojiElements = [];
        
        // Drawing variables
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let drawingEnabled = false;
        
        // Initialize editor with the image
        function initEditor() {
            originalImage.onload = function() {
                originalWidth = originalImage.width;
                originalHeight = originalImage.height;
                
                // Set canvas dimensions
                canvas.width = originalWidth;
                canvas.height = originalHeight;
                
                // Draw the original image
                drawImage();
                
                // Update resize inputs
                document.getElementById('width').value = originalWidth;
                document.getElementById('height').value = originalHeight;
                
                // Create initial preview
                updatePreview();
            };
            
            // Get the image URL from the server
            originalImage.src = "{{ post.file.url }}";
        }
        
        // Function to draw the image with current filters
        function drawImage() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Apply the filters
            ctx.filter = getFiltersString();
            
            // Draw the image
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
            
            // Reset filter after drawing the base image
            ctx.filter = 'none';
            
            // Draw text elements
            drawTextElements();
            
            // Draw emoji elements
            drawEmojiElements();
        }
        
        // Get current filter string
        function getFiltersString() {
            let filters = [];
            
            // Add brightness and contrast
            filters.push(`brightness(${currentState.brightness}%)`);
            filters.push(`contrast(${currentState.contrast}%)`);
            
            // Add grayscale if active
            if (currentState.grayscale) {
                filters.push('grayscale(100%)');
            }
            
            // Add sepia if active
            if (currentState.sepia) {
                filters.push('sepia(100%)');
            }
            
            // Add invert if active
            if (currentState.invert) {
                filters.push('invert(100%)');
            }
            
            return filters.join(' ');
        }
        
        // Draw text elements
        function drawTextElements() {
            textElements.forEach(element => {
                ctx.font = `${element.fontSize}px ${element.fontFamily}`;
                ctx.fillStyle = element.color;
                ctx.fillText(element.text, element.x, element.y);
            });
        }
        
        // Draw emoji elements
        function drawEmojiElements() {
            emojiElements.forEach(element => {
                ctx.font = `${element.size}px Arial`;
                ctx.fillText(element.emoji, element.x, element.y);
            });
        }
        
        // Update preview image
        function updatePreview() {
            const previewImage = document.getElementById('previewImage');
            previewImage.src = canvas.toDataURL('image/png');
        }
        
        // Filter buttons
        document.querySelectorAll('[data-filter]').forEach(button => {
            button.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                
                // Toggle filter state
                currentState[filter] = !currentState[filter];
                
                // Update button styling
                if (currentState[filter]) {
                    this.classList.replace('btn-outline-primary', 'btn-primary');
                } else {
                    this.classList.replace('btn-primary', 'btn-outline-primary');
                }
                
                // Redraw image
                drawImage();
                updatePreview();
            });
        });
        
        // Brightness slider
        document.getElementById('brightness').addEventListener('input', function() {
            currentState.brightness = this.value;
            drawImage();
            updatePreview();
        });
        
        // Contrast slider
        document.getElementById('contrast').addEventListener('input', function() {
            currentState.contrast = this.value;
            drawImage();
            updatePreview();
        });
        
        // Resize functionality
        document.getElementById('applyResize').addEventListener('click', function() {
            const newWidth = parseInt(document.getElementById('width').value);
            const newHeight = parseInt(document.getElementById('height').value);
            
            if (newWidth > 0 && newHeight > 0) {
                canvas.width = newWidth;
                canvas.height = newHeight;
                drawImage();
                updatePreview();
            }
        });
        
        // Maintain aspect ratio
        document.getElementById('width').addEventListener('input', function() {
            if (document.getElementById('maintainAspectRatio').checked) {
                const aspectRatio = originalHeight / originalWidth;
                const newWidth = parseInt(this.value);
                document.getElementById('height').value = Math.round(newWidth * aspectRatio);
            }
        });
        
        document.getElementById('height').addEventListener('input', function() {
            if (document.getElementById('maintainAspectRatio').checked) {
                const aspectRatio = originalWidth / originalHeight;
                const newHeight = parseInt(this.value);
                document.getElementById('width').value = Math.round(newHeight * aspectRatio);
            }
        });
        
        // Add text functionality
        document.getElementById('addText').addEventListener('click', function() {
            const text = document.getElementById('textInput').value;
            
            if (text) {
                const fontSize = parseInt(document.getElementById('fontSize').value);
                const color = document.getElementById('textColor').value;
                const fontFamily = document.getElementById('fontFamily').value;
                
                // Add text to the center of the canvas
                textElements.push({
                    text: text,
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    fontSize: fontSize,
                    color: color,
                    fontFamily: fontFamily
                });
                
                // Redraw and update preview
                drawImage();
                updatePreview();
                
                // Clear the input
                document.getElementById('textInput').value = '';
            }
        });
        
        // Emoji functionality
        document.querySelectorAll('.emoji-item').forEach(item => {
            item.addEventListener('click', function() {
                const emoji = this.getAttribute('data-emoji');
                const size = parseInt(document.getElementById('emojiSize').value);
                
                // Add emoji to the center of the canvas
                emojiElements.push({
                    emoji: emoji,
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    size: size
                });
                
                // Redraw and update preview
                drawImage();
                updatePreview();
            });
        });
        
        // Drawing functionality
        document.getElementById('enableDrawing').addEventListener('click', function() {
            drawingEnabled = true;
            canvas.style.cursor = 'crosshair';
        });
        
        document.getElementById('disableDrawing').addEventListener('click', function() {
            drawingEnabled = false;
            canvas.style.cursor = 'default';
        });
        
        // Mouse events for drawing
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        function startDrawing(e) {
            if (!drawingEnabled) return;
            
            isDrawing = true;
            
            // Get the position relative to the canvas
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }
        
        function draw(e) {
            if (!isDrawing || !drawingEnabled) return;
            
            // Get current brush settings
            const brushSize = parseInt(document.getElementById('brushSize').value);
            const brushColor = document.getElementById('brushColor').value;
            
            // Get the position relative to the canvas
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            // Draw line
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.strokeStyle = brushColor;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            // Update last position
            lastX = currentX;
            lastY = currentY;
            
            // Update preview
            updatePreview();
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        // Reset image
        document.getElementById('resetImage').addEventListener('click', function() {
            // Reset canvas dimensions
            canvas.width = originalWidth;
            canvas.height = originalHeight;
            
            // Reset filters
            currentState = {
                brightness: 100,
                contrast: 100,
                grayscale: false,
                sepia: false,
                invert: false
            };
            
            // Reset sliders
            document.getElementById('brightness').value = 100;
            document.getElementById('contrast').value = 100;
            
            // Reset filter buttons
            document.querySelectorAll('[data-filter]').forEach(button => {
                button.classList.replace('btn-primary', 'btn-outline-primary');
            });
            
            // Clear text and emoji elements
            textElements = [];
            emojiElements = [];
            
            // Reset resize inputs
            document.getElementById('width').value = originalWidth;
            document.getElementById('height').value = originalHeight;
            
            // Redraw and update preview
            drawImage();
            updatePreview();
        });
        
        // Save image
        document.getElementById('saveImage').addEventListener('click', function() {
            // Get the final image data
            const imageData = canvas.toDataURL('image/png');
            
            // Set the form value and submit
            document.getElementById('editedImageData').value = imageData;
            document.getElementById('editedImageForm').submit();
        });
        
        // Initialize the editor
        initEditor();
    });
</script>
{% endblock %}